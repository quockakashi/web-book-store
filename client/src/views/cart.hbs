<main class="px-4 container-fluid" style="margin-bottom: 40px; max-width: 1200px; width: 100%; margin-top: 40px">
  <input type="hidden" value="{{user.wallet}}" id="userWallet">
    <div class="row" style="width: 100%;">
        <div class="card-body mt-5 pt-5">
          <ul class="nav nav-tabs nav-tabs-bordered m-auto gap-3 fw-bold fs-5">
            <li class="nav-item">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#about-product"
                id="btn-about-product">
                Cart
              </button>
            </li>

            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#details" id="btn-details">
                Payment
              </button>
            </li>
          </ul>
      </div>
    </div>
    <div class="row width-100">
      <div class="tab-content mt-4 mb-4">
        <div class="tab-pane fade show active about-product" id="about-product">
          <div class="row" style="gap: 32px">
            <div class="col-lg-7 bg-light p-4 rounded-3">
                <div class="card-body bg-light">
                  <h5 class="card-title"></h5>

                  <!-- Default Table -->
                  <table class="table table-light" style="background: inherit;">
                    <thead>
                        <th scope="col">Product</th>
                        <th scope="col">Quantity</th>
                        <th scope="col">Price</th>
                        <th scope="col">Subtotal</th>
                      </tr>
                    </thead>
                    <tbody id="table-cart">
                      {{!-- <tr>
                        <td scope="row">
                          <div class="d-flex justify-content-start align-items-center">
                            <div class="avatar-wrapper me-3">
                              <div style="width: 80px;height: 96px;">
                                <img src="./assets/img/messages-1.jpg" class="w-100 h-100" alt="Avatar" />
                              </div>
                            </div>
                            <div class="d-flex flex-column">
                              <a href="about-product.php" class="text-truncate">
                                <span class="text-heading fs-7 fw-medium">Cristine
                                  Easom</span>
                              </a>
                              <a href="javascript:void(0)" class="d-flex align-items-center fw-medium text-secondary"><i
                                  class="bi bi-x fs-3"></i> Xóa bỏ</a>
                            </div>
                          </div>
                        </td>
                        <td style="vertical-align:middle">
                          <div class="form-group" style="width: 84px;">
                            <input type="number" class="form-control" value="1" min="1" />
                          </div>
                        </td>
                        <td style="vertical-align:middle">
                          <span>19000000</span>
                          <sup>đ</sup>
                        </td>
                        <td class="fw-bold" style="vertical-align:middle">
                          <span>19000000</span>
                          <sup>đ</sup>
                        </td>
                      </tr> --}}
                    </tbody>
                  </table>
                  <!-- End Default Table Example -->
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card-body px-2">
                  <div class="card-title fw-bold mb-2">Details</div>

                  <div class="row px-3 gap-3">
                    <div class="form-group border border-2 border-dark p-3">
                      <div class="form-check fs-5">
                        <input class="form-check-input" value="Giao hàng miễn phí" type="radio" name="shipping_method"
                          id="flexRadioDefault1" checked />
                        <label class="form-check-label" for="flexRadioDefault1">
                          Free Shipping
                        </label>
                      </div>
                    </div>
                    <div class="form-group border border-2 border-dark p-3">
                      <div class="form-check fs-5">
                        <input class="form-check-input" value="Giao hàng hỏa tốc" type="radio" name="shipping_method"
                          id="flexRadioDefault2" />
                        <label class="form-check-label" for="flexRadioDefault2">
                          Express Shipping
                        </label>
                      </div>
                    </div>
                  </div>

                  <div class="px-3 d-flex justify-content-between mt-4">
                    <span class="fw-bold fs-4">Total:</span>
                    <span class="fs-4"><span class="total-bill" id="total-bill">0</span><sup>đ</sup></span>
                  </div>

                  <button class="btn btn-dark mt-3 w-100 p-3" id="btn-payment">Purchase</button>
                </div>
              </div>
          </div>
        </div>
        <div class="tab-pane fade details" id="details">
          <div class="row" style="gap: 32px">
            <div class="col-lg-6 bg-light p-4 rounded-3">
              <div  id="formAddOrder">
                  <div class="card-body">
                    <h4 class="card-title fw-bold fs-5 mb-4">Contact Information</h4>

                    <div class="row">
                      <div class="col-lg-12 mb-3">
                        <label for="firstname" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="fullName" value="{{user.fullName}}" required/>
                      </div>
                      <div class="col-lg-12 mb-3">
                        <label for="phone" class="form-label">Phone number</label>
                        <input type="text" class="form-control" id="phone" value="{{user.phoneNumber}}" required/>
                      </div>
                      <div class="col-12 mb-3">
                        <label for="address" class="form-label">Address</label>
                        <textarea type="text" class="form-control" id="address" required></textarea>
                      </div>
                      <div class="col-12 mb-3">
                        <label for="address" class="form-label">Note</label>
                        <textarea type="text" class="form-control" id="note"></textarea>
                      </div>
                      <!-- <div class="tab-content">
                                              <div class="tab-pane fade show active cod" id="cod">
                                                hello
                                              </div>
                                              <div class="tab-pane fade show pay" id="pay">
                                                pay
                                              </div>
                                            </div> -->
                    </div>

                    <button class="btn btn-dark w-100 p-3 buy-now" disabled id="btn-confirm">Buy Now</button>
                  </div>
              </div>
            </div>
            <div class="col-lg-5">
                <div class="card-body">
                  <div class="card-title fw-bold">Detail Cart</div>
                  <div class="row">
                    <table class="table">
                      <tbody id="table-cart-2">

                      </tbody>
                      <tfoot>
                        <tr>
                          <td scope="row" class="fw-bold fs-5">
                            Total
                          </td>
                          <td><span class="fs-6 fw-bold"><span class="total-bill"
                                id="total-bill-detail"></span><sup>đ</sup></span></td>
                        </tr>
                      </tfoot>
                    </table>
                    <div class="hide insufficient-alert">
                      <p class="text-danger mb-3" style="font-size: 14px;">
                          Insufficient funds in your wallet. Please deposit an additional <span class="amount-insufficient"></span>đ.
                      </p>
                      <a href="/wallet" class="btn btn-dark" target="_blank">
                        My Wallet
                      </a>
                    </div>

                  </div>
                </div>
              </div>
            </div>
        </div>

      </div>
    </div>
</main>
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
  crossorigin="anonymous"></script>
<script>
  var cart = JSON.parse(localStorage.getItem('cart')) || [];
  var total = 0;
  var balance = 0;
  var products = [];
  const handleDelete = (id) => {
    cart = cart.filter(function (item) {
      return item.id !== id;
    });
    let product = products.find(product => product._id === id);
    total -= Number.parseInt(product.quantityIncart) * product.price;
    $('#total-bill').text(total.toLocaleString());
    $('#total-bill-detail').text(total.toLocaleString());
    $(`tr[bookId="${id}"]`).remove()

    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartSize();
    checkBalance();
  }
  async function getProducts () {
      const response = await fetch('/api/products/by-ids/' + cart.map(p => p.id).join("_"));
      const { data } = await response.json();

      const filteredBooks = data
        .map(book => {
          const newItem = cart.find(item => item.id === book._id);
          if (newItem) {
            return { ...book, quantityIncart: newItem.quantity };
          }
        })
        .filter(item => item !== undefined);
      products = [...filteredBooks];
      console.log(products);
  }

  async function fetchData() {
    
      products.forEach((book) => {
        total += book.quantityIncart * book.price;
        console.log(total)
        let htmls = `
                                    <tr bookId="${book._id}">
                                        <td scope="row">
                                        <div class="d-flex justify-content-start align-items-center">
                                            <div class="avatar-wrapper me-3">
                                            <div style="width: 80px;height: 96px;">
                                                <img src="${book.image}" class="w-100 h-100" alt="Avatar">
                                            </div>
                                            </div>
                                            <div class="d-flex flex-column">
                                            <a href="http://localhost:8080/books/${book._id}" class="">
                                                <span style="width: 200px" class="d-block text-truncate text-heading fs-7 fw-medium">${book.name}</span>
                                            </a>
                                            <button onclick="handleDelete('${book._id}')" href="handleDelete" class="btn btn-danger d-flex align-items-center fw-medium text-secondary text-white mt-2" style="font-size: 14px; padding: 4px 8px; width: fit-content"><i class="fa-solid fa-trash"></i> <span class="ms-2">Remove</span></button>
                                            </div>
                                        </div>
                                        </td>
                                        <td style="vertical-align:middle">
                                        <div class="form-group" style="width: 84px;">
                                            <input type="number" class="form-control" value="${book.quantityIncart}" readonly min="1">
                                        </div>
                                        </td>
                                        <td style="vertical-align:middle">
                                        <span>${book.price.toLocaleString()}</span>
                                        <sup>đ</sup>
                                        </td>
                                        <td class="fw-bold" style="vertical-align:middle">
                                        <span>${(book.price * book.quantityIncart).toLocaleString()}</span>
                                        <sup>đ</sup>
                                        </td>
                                    </tr>
                                `
        $('#table-cart').append(htmls)
      })
      $('#total-bill').text(total.toLocaleString());
      $('#total-bill-detail').text(total.toLocaleString());
    }

  $(document).ready(async function () {
    await getProducts();
    await fetchData();
    console.log(total)
    const userWallet = $('#userWallet').val();
    const balanceResponse = await fetch('/api/payment/balance');
    balance = (await balanceResponse.json()).balance;

    checkBalance();



    // Gán sự kiện click cho nút có id là "btn-payment"
    $('#btn-payment').click(function () {
      console.log('Nút "Thanh toán" đã được click.');
      $('#btn-about-product').removeClass('active');
      $('#btn-details').addClass('active');
      $('#about-product').removeClass('show active');
      $('#details').addClass('show active');
    });
    $('#btn-details').click(function () {
      $('#btn-about-product').removeClass('active');
      $('#btn-details').addClass('active');
      $('#about-product').removeClass('show active');
      $('#details').addClass('show active');
    });
    $('#btn-about-product').click(function () {
      $('#btn-details').removeClass('active');
      $('#btn-about-product').addClass('active');
      $('#about-product').addClass('show active');
      $('#details').removeClass('show active');
    });

    $('.buy-now').click(async () => {
      const response = await fetch('/api/orders', {
        method: 'post',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          products: cart,
          total: total,
        })
      })

      if(response.status === 201) {
        cart = [],
        total = 0;
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartSize();
        $('#table-cart').empty();
        alert('Payment successful! Thank you!');
        window.location.href = '/';
      } else {
        alert('Payment failed! Try again!');
      }
    });

  });

  function checkBalance() {
    if(balance >= total) {
      console.log(total)
      $('.buy-now').removeAttr('disabled')
      $('.insufficient-alert').addClass('hide')
    } else {
      $('.amount-insufficient').text((total - balance).toLocaleString('vi-VN'))
      $('.insufficient-alert').removeClass('hide')
    }
  }
    

</script>