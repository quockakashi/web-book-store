<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
  integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />
<main class="main bg-white">
  <div class="section container-2xxl">
    <div class="row">
      <div class="card">
        <div class="card-body mt-5 pt-5">
          <ul class="nav nav-tabs nav-tabs-bordered w-fit m-auto gap-3 fw-bold fs-4">
            <li class="nav-item">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#about-product"
                id="btn-about-product">
                Giỏ hàng
              </button>
            </li>

            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#details" id="btn-details">
                Thanh toán
              </button>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="tab-content mt-4 mb-4">
        <div class="tab-pane fade show active about-product" id="about-product">
          <div class="row">
            <div class="col-lg-7">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title"></h5>

                  <!-- Default Table -->
                  <table class="table">
                    <thead>
                      <tr>
                        <th scope="col">Sản phẩm</th>
                        <th scope="col">Số lượng</th>
                        <th scope="col">Gía</th>
                        <th scope="col">Tổng giá</th>
                      </tr>
                    </thead>
                    <tbody id="table-cart">
                      {{!-- <tr>
                        <td scope="row">
                          <div class="d-flex justify-content-start align-items-center">
                            <div class="avatar-wrapper me-3">
                              <div style="width: 80px;height: 96px;">
                                <img src="./assets/img/messages-1.jpg" class="w-100 h-100" alt="Avatar" />
                              </div>
                            </div>
                            <div class="d-flex flex-column">
                              <a href="about-product.php" class="text-truncate">
                                <span class="text-heading fs-7 fw-medium">Cristine
                                  Easom</span>
                              </a>
                              <a href="javascript:void(0)" class="d-flex align-items-center fw-medium text-secondary"><i
                                  class="bi bi-x fs-3"></i> Xóa bỏ</a>
                            </div>
                          </div>
                        </td>
                        <td style="vertical-align:middle">
                          <div class="form-group" style="width: 84px;">
                            <input type="number" class="form-control" value="1" min="1" />
                          </div>
                        </td>
                        <td style="vertical-align:middle">
                          <span>19000000</span>
                          <sup>đ</sup>
                        </td>
                        <td class="fw-bold" style="vertical-align:middle">
                          <span>19000000</span>
                          <sup>đ</sup>
                        </td>
                      </tr> --}}
                    </tbody>
                  </table>
                  <!-- End Default Table Example -->
                </div>
              </div>
            </div>
            <div class="col-lg-5">
              <div class="card border border-2 border-dark">
                <div class="card-body">
                  <div class="card-title fw-bold">Chi tiết giỏ hàng</div>

                  <div class="row px-3 gap-3">
                    <div class="form-group border border-2 border-dark p-3">
                      <div class="form-check fs-5">
                        <input class="form-check-input" value="Giao hàng miễn phí" type="radio" name="shipping_method"
                          id="flexRadioDefault1" checked />
                        <label class="form-check-label" for="flexRadioDefault1">
                          Giao hàng miễn phí
                        </label>
                      </div>
                    </div>
                    <div class="form-group border border-2 border-dark p-3">
                      <div class="form-check fs-5">
                        <input class="form-check-input" value="Giao hàng hỏa tốc" type="radio" name="shipping_method"
                          id="flexRadioDefault2" />
                        <label class="form-check-label" for="flexRadioDefault2">
                          Giao hàng hỏa tốc
                        </label>
                      </div>
                    </div>
                  </div>

                  <div class="px-3 d-flex justify-content-between mt-4">
                    <span class="fw-bold fs-4">Tổng:</span>
                    <span class="fs-4"><span class="total-bill" id="total-bill"></span><sup>đ</sup></span>
                  </div>

                  <button class="btn btn-dark mt-3 w-100 p-3" id="btn-payment">Thanh toán</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade details" id="details">
          <div class="row">
            <div class="col-lg-7">
              <form action="" id="formAddOrder">
                <div class="card">
                  <div class="card-body">
                    <h4 class="card-title fw-bold fs-5">Thông tin liên lạc</h4>

                    <div class="row">
                      <div class="col-lg-6 mb-3">
                        <label for="firstname" class="form-label">Họ</label>
                        <input type="text" class="form-control" id="firstname" />
                      </div>
                      <div class="col-lg-6 mb-3">
                        <label for="lastname" class="form-label">Tên</label>
                        <input type="text" class="form-control" id="lastname" />
                      </div>
                      <div class="col-lg-6 mb-3">
                        <label for="phone" class="form-label">Số điện thoại</label>
                        <input type="text" class="form-control" id="phone" />
                      </div>
                      <div class="col-lg-6 mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" />
                      </div>
                      <div class="col-12 mb-3">
                        <label for="address" class="form-label">Địa chỉ</label>
                        <textarea type="text" class="form-control" id="address"></textarea>
                      </div>
                      <div class="col-12 mb-3">
                        <label for="address" class="form-label">Ghi chú</label>
                        <textarea type="text" class="form-control" id="note"></textarea>
                      </div>
                      <div class="col-12 mb-3 gap-3 nav nav-tabs nav-tabs-bordered">
                        <div class="form-check form-switch nav-item">
                          <input class="form-check-input active" type="radio" id="flexSwitchCheckDefault" value="COD"
                            name="payment-method" checked data-bs-toggle="tab" data-bs-target="#cod" />
                          <label class="form-check-label" for="flexSwitchCheckDefault">Thanh
                            toán khi nhận hàng</label>
                        </div>
                        <div class="form-check form-switch nav-item">
                          <input class="form-check-input" type="radio" id="flexSwitchCheckChecked" value="OnlineBanking"
                            name="payment-method" data-bs-toggle="tab" data-bs-target="#pay" />
                          <label class="form-check-label" for="flexSwitchCheckChecked">Thanh
                            toán chuyển khoản</label>
                        </div>
                      </div>
                      <!-- <div class="tab-content">
                                              <div class="tab-pane fade show active cod" id="cod">
                                                hello
                                              </div>
                                              <div class="tab-pane fade show pay" id="pay">
                                                pay
                                              </div>
                                            </div> -->
                    </div>

                    <button class="btn btn-dark w-100 p-3 buy-now" id="btn-confirm">Đặt hàng</button>
                  </div>
                </div>
              </form>
            </div>
            <div class="col-lg-5">
              <div class="card">
                <div class="card-body">
                  <div class="card-title fw-bold">Chi tiết giỏ hàng</div>
                  <div class="row">
                    <table class="table">
                      <tbody id="table-cart-2">

                      </tbody>
                      <tfoot>
                        <tr>
                          <td scope="row" class="fw-bold fs-5">
                            Tổng
                          </td>
                          <td><span class="fs-6 fw-bold"><span class="total-bill"
                                id="total-bill-detail"></span><sup>đ</sup></span></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</main>
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
  crossorigin="anonymous"></script>
<script>
  const searchParams = new URLSearchParams(window.location.search);
  const vnp_ResponseCode = searchParams.get('vnp_ResponseCode');
  console.log(vnp_ResponseCode)
  const handleDelete = (id) => {
    console.log(id)
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    var newArray = cart.filter(function (item) {
      return item.id !== id;
    });

    localStorage.setItem('cart', JSON.stringify(cart))
    fetchData()
  }

  let products = [];
  let total = 0;
  async function fetchData() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    $('#table-cart').empty();
    try {
      const response = await fetch('/api/products/by-ids/' + cart.map(p => p.id).join("_"));
      const { data } = await response.json();

      const filteredBooks = data
        .map(book => {
          const newItem = cart.find(item => item.id === book._id);
          if (newItem) {
            return { ...book, quantityIncart: newItem.quantity };
          }
        })
        .filter(item => item !== undefined);
      products = [...filteredBooks];
      filteredBooks.forEach((book) => {
        total += book.quantityIncart * book.price;
        let htmls = `
                                    <tr>
                                        <td scope="row">
                                        <div class="d-flex justify-content-start align-items-center">
                                            <div class="avatar-wrapper me-3">
                                            <div style="width: 80px;height: 96px;">
                                                <img src="${book.image}" class="w-100 h-100" alt="Avatar">
                                            </div>
                                            </div>
                                            <div class="d-flex flex-column">
                                            <a href="http://localhost:8080/books/${book._id}" class="">
                                                <span style="width: 300px" class="d-block text-truncate text-heading fs-7 fw-medium">${book.name}</span>
                                            </a>
                                            <a onclick="handleDelete('${book._id}')" href="javascript:void(0)" class="d-flex align-items-center fw-medium text-secondary"><i class="bi bi-x fs-3"></i> Xóa bỏ</a>
                                            </div>
                                        </div>
                                        </td>
                                        <td style="vertical-align:middle">
                                        <div class="form-group" style="width: 84px;">
                                            <input type="number" class="form-control" value="${book.quantityIncart}" min="1">
                                        </div>
                                        </td>
                                        <td style="vertical-align:middle">
                                        <span>${book.price.toLocaleString()}</span>
                                        <sup>đ</sup>
                                        </td>
                                        <td class="fw-bold" style="vertical-align:middle">
                                        <span>${(book.price * book.quantityIncart).toLocaleString()}</span>
                                        <sup>đ</sup>
                                        </td>
                                    </tr>
                                `
        $('#table-cart').append(htmls)
      })
      $('#total-bill').text(total.toLocaleString());
      $('#total-bill-detail').text(total.toLocaleString());
    } catch (error) {
      console.error('Error fetching data:', error);
    }
  }
  $(document).ready(function () {
    // Gán sự kiện click cho nút có id là "btn-payment"
    $('#btn-payment').click(function () {
      console.log('Nút "Thanh toán" đã được click.');
      $('#btn-about-product').removeClass('active');
      $('#btn-details').addClass('active');
      $('#about-product').removeClass('show active');
      $('#details').addClass('show active');
    });
    $('#btn-details').click(function () {
      $('#btn-about-product').removeClass('active');
      $('#btn-details').addClass('active');
      $('#about-product').removeClass('show active');
      $('#details').addClass('show active');
    });
    $('#btn-about-product').click(function () {
      $('#btn-details').removeClass('active');
      $('#btn-about-product').addClass('active');
      $('#about-product').addClass('show active');
      $('#details').removeClass('show active');
    });
    $('#btn-confirm').click(function (e) {
      e.preventDefault();
      const paymentMethod = $('input[name="payment-method"]:checked').val() == '#cod' ? 0 : 1;
      fetch('/api/vn-pay/create-payment?amount=' + total).then(res => res.json()).then(res => {
        const { id, data } = res;
        console.log(paymentMethod)
        if (paymentMethod)
          localStorage.setItem('pending',
            JSON.stringify({ orderId: id, products: products })
          );
        else
          localStorage.setItem('success',
            JSON.stringify(
              [
                { orderId: id, products: products },
                ...(JSON.parse(localStorage.getItem('success')) || [])
              ]
            )
          );
        window.location.href = data;
      });
    });
  });
  
  function returnPayment() {
    if (vnp_ResponseCode == '00') {
      const query = window.location.href.split('?').filter((u, index) => index !== 0).join()
      fetch('/api/vn-pay/confirm-payment?' + query).then(res => res.json()).then(res => {
        const { data } = res;
        if (localStorage.getItem('pending'))
          localStorage.setItem('success',
            JSON.stringify([
              JSON.parse(localStorage.getItem('pending')),
              ...(JSON.parse(localStorage.getItem('success')) || [])
            ]
            )
          );
        localStorage.setItem("authenticatedUser", JSON.stringify(
          { ...JSON.parse(localStorage.getItem('authenticatedUser')), cartItems: [] }
        ));
        localStorage.removeItem("pending");
        alert("Mua hàng thành công");
        fetchData();
      });
    }
    else {
      localStorage.removeItem("pending");
      alert("Mua hàng chưa thành công! Vui lòng thử lại hoặc liên hệ với chúng tôi.")
      fetchData();
    }

  }
  // Gán sự kiện click cho nút hoặc thành phần khác
  if (vnp_ResponseCode != null || vnp_ResponseCode != undefined)
    returnPayment()
  else
    fetchData();

</script>