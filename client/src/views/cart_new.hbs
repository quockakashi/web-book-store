<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <title>{{title}} | HCMUS Book Store</title>
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"></script>
        <script src="https://kit.fontawesome.com/0f8c4fe9ac.js" crossorigin="anonymous"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
            integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
        <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
            crossorigin="anonymous"></script>
        <link rel="stylesheet" type="text/css" href="/css/general.css" />
        <link rel="stylesheet" type="text/css" href="/css/homepage.css" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.min.css">
        <style>
            body {
                background: linear-gradient(110deg, #BBDEFB 60%, #42A5F5 60%);
            }

            .shop {
                font-size: 10px;
            }

            .space {
                letter-spacing: 0.8px !important;
            }

            .second a:hover {
                color: rgb(92, 92, 92);
            }

            .active-2 {
                color: rgb(92, 92, 92)
            }


            .breadcrumb>li+li:before {
                content: "" !important
            }

            .breadcrumb {
                padding: 0px;
                font-size: 10px;
                color: #aaa !important;
            }

            .first {
                background-color: white;
            }

            a {
                text-decoration: none !important;
                color: #aaa;
            }

            .btn-lg,
            .form-control-sm:focus,
            .form-control-sm:active,
            a:focus,
            a:active {
                outline: none !important;
                box-shadow: none !important
            }

            .form-control-sm:focus {
                border: 1.5px solid #4bb8a9;
            }

            .btn-group-lg>.btn,
            .btn-lg {
                padding: .5rem 0.1rem;
                font-size: 1rem;
                border-radius: 0;
                color: white !important;
                background-color: #4bb8a9;
                height: 2.8rem !important;
                border-radius: 0.2rem !important;
            }

            .btn-group-lg>.btn:hover,
            .btn-lg:hover {
                background-color: #26A69A;
            }

            .btn-outline-primary {
                background-color: #fff !important;
                color: #4bb8a9 !important;
                border-radius: 0.2rem !important;
                border: 1px solid #4bb8a9;
            }

            .btn-outline-primary:hover {
                background-color: #4bb8a9 !important;
                color: #fff !important;
                border: 1px solid #4bb8a9;
            }

            .card-2 {
                margin-top: 40px !important;
            }

            .card-header {
                background-color: #fff;
                border-bottom: 0px solid #aaaa !important;
            }

            p {
                font-size: 13px;
            }

            .small {
                font-size: 9px !important;
            }

            .form-control-sm {
                height: calc(2.2em + .5rem + 2px);
                font-size: .875rem;
                line-height: 1.5;
                border-radius: 0;
            }

            .cursor-pointer {
                cursor: pointer;
            }

            .boxed {
                padding: 0px 8px 0 8px;
                background-color: #4bb8a9;
                color: white;
            }

            .boxed-1 {
                padding: 0px 8px 0 8px;
                color: black !important;
                border: 1px solid #aaaa;
            }

            .bell {
                opacity: 0.5;
                cursor: pointer;
            }

            @media (max-width: 767px) {
                .breadcrumb-item+.breadcrumb-item {
                    padding-left: 0
                }
            }
        </style>
    </head>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"></script>


<body>
    <header style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 99;
        box-shadow: 5px 5px 5px 0 rgba(0, 0, 0, 0.05);
      " class="bg-white">
        <nav class="d-flex align-items-center p-3 mx-auto" style="gap: 32px; max-width: 1200px">
            <a style="font-size: 24px" href="/">Book Store</a>
            <div class="d-flex justify-content-center align-items-center gap-4" style="flex: 1; position: relative">
                <button class="border-0 text-primary category-btn" style="background-color: inherit">
                    <i class="fa-solid fa-bars-progress"></i>
                </button>
                <div class="category-menu hide bg-white rounded-3 shadow-lg" style="
              position: absolute;
              z-index: 999;
              top: 100%;
              padding: 12px 24px;
            ">
                    <ul class="category-list" style="
                display: grid;
                list-style: none;
                grid-template-columns: 1fr 1fr 1fr 1fr;
                padding: 0;
                row-gap: 16px;
                column-gap: 32px;
              "></ul>
                </div>
                <form style="max-width: 500px; width: 100%" action="/books">
                    <div class="input-group mb-3 rounded-4 overflow-hidden shadow-sm mt-3">
                        <input type="text" class="search-input form-control border-0 shadow-none"
                            aria-label="Amount (to the nearest dollar)" placeholder="Find your book!" required
                            name="keyword" />
                        <button type="submit" class="input-group-text border-0 text-primary"
                            style="background-color: inherit">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </button>
                    </div>
                </form>
            </div>
            <nav class="1-navbar" id="navbar">
                <nav class="nav">
                    <div class="nav-list">
                        <a class="nav_link" href="/recharge" style="margin-left: 5px; margin-right: 5px">
                            <i class="fa-solid fa-sack-dollar"></i>
                            <span class="nav_name">Recharge</span>
                        </a>
                        <a class="nav_link" href="/cart" style="margin-left: 5px; margin-right: 5px">
                            <i class="fa-solid fa-cart-shopping"></i>
                            <span class="nav_name">Cart</span>
                        </a>
                        <a class="nav_link" href="#" style="margin-left: 5px; margin-right: 5px">
                            <i class="fa-regular fa-user"></i>
                            <span class="nav_name">Account</span>
                        </a>
                    </div>
                </nav>
            </nav>
        </nav>
    </header>
    <div class=" " style="margin-top: 120px">
        <div class="row justify-content-center ">
            <div class="col-xl-10">
                <div class="card shadow-lg" style="width: 1150px; height:680px">
                    <div class="row p-2 mt-3 justify-content-between mx-sm-2">
                        <div class="col">
                            <p class="text-muted space mb-0 shop">HCMUS-BOOK_STORE</p>
                        </div>
                    </div>
                    <div class="row  mx-auto justify-content-center text-center">
                        <div class="col-12 mt-3 ">
                            <nav aria-label="breadcrumb" class="second ">
                                <ol class="breadcrumb indigo lighten-6 first  ">
                                    <li class="breadcrumb-item font-weight-bold "><a class="black-text text-uppercase "
                                            href="/"><span class="mr-md-3 mr-1">BACK TO SHOP</span></a><i
                                            class="fa fa-angle-double-right " aria-hidden="true"></i></li>
                                    <li class="breadcrumb-item font-weight-bold"><a
                                            class="black-text text-uppercase active-2" href="#"><span
                                                class="mr-md-3 mr-1">CHECKOUT</span></a></li>
                                </ol>
                            </nav>
                        </div>
                    </div>

                    <div class="row justify-content-around">
                        <div class="col-md-5" style="width: 500px;">
                            <div class="card border-0" style="width:450px">
                                <div class="card-header pb-0" style="width:450px">
                                    <h2 class="card-title space ">Checkout</h2>
                                    <p class="card-text text-muted mt-4  space">SHIPPING DETAILS</p>
                                    <hr class="my-0">
                                </div>
                                <div class="card-body" style="width: 450px;">
                                    <div class="row justify-content-between">
                                        <div class="col-auto mt-0">
                                            <p><b>University of Science, Ward 6, Thu Duc City, Ho Chi Minh City</b></p>
                                        </div>
                                        <br>
                                        <div class="col-auto">
                                            <p><b>Email:ctduong010803@gmail.com</b> </p>
                                        </div>
                                    </div>
                                    <div class="row mt-4">
                                        <div class="col">
                                            <p class="text-muted mb-2">PAYMENT DETAILS</p>
                                            <hr class="mt-0">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="NAME" class="small text-muted mb-1">USERNAME</label>
                                        <input type="text" class="form-control form-control-sm" name="NAME" id="NAME"
                                            aria-describedby="helpId" placeholder="USERNAME">
                                    </div>
                                    <div class="form-group">
                                        <label for="NAME" class="small text-muted mb-1">YOUR BALANCE</label>
                                        <input type="text" class="form-control form-control-sm" name="NAME" id="NAME"
                                            aria-describedby="helpId" placeholder="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="NAME" class="small text-muted mb-1">REMAIN AFTER PURCHASE: </label>
                                        <input type="text" class="form-control form-control-sm" name="NAME" id="NAME"
                                            aria-describedby="helpId" placeholder="0">
                                    </div>
                                    <div class="row mb-md-5" style="margin-top:10px">
                                        <div class="col">
                                            <button type="button" name="" id=""
                                                class="btn  btn-lg btn-block ">PURCHASE</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5" style="width:500px;height: 480px">
                            <div class="card border-0 " style="width:450px">
                                <div class="card-header" style="width:450px; margin-top:0px">
                                    <p class="card-text text-muted mt-md-4  mb-2 space">YOUR ORDER <span
                                            class=" small text-muted ml-2 cursor-pointer">EDIT SHOPPING BAG</span> </p>
                                    <hr class="my-2">
                                </div>
                                <div class="card-body pt-0" style="width:450px;height:400px; overflow:auto" id="list-product-cart">
                                    <div class="row  justify-content-between">
                                        <div class="col-auto col-md-7">
                                            <div class="media flex-column flex-sm-row">
                                                <img class=" img-fluid" src="https://i.imgur.com/6oHix28.jpg" width="62"
                                                    height="62">
                                                <div class="media-body  my-auto">
                                                    <div class="row ">
                                                        <div class="col-auto">
                                                            <p class="mb-0"><b>EC-GO Bag Standard</b></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class=" pl-0 flex-sm-col col-auto  my-auto">
                                            <p class="boxed-1">1</p>
                                        </div>
                                        <div class=" pl-0 flex-sm-col col-auto  my-auto ">
                                            <p><b>179.000</b><b>đ</b></p>
                                        </div>
                                    </div>
                                </div>
                                <hr class="my-2">
                                <div class="row ">
                                    <div class="col">
                                        <div class="row justify-content-between">
                                            <div class="col-4">
                                                <p class="mb-1"><b>Subtotal</b></p>
                                            </div>
                                            <div class="flex-sm-col col-auto">
                                                <p class="mb-1" ><b id="total-1"></b><b>đ</b></p>
                                            </div>
                                        </div>
                                        <div class="row justify-content-between">
                                            <div class="col">
                                                <p class="mb-1"><b>Shipping</b></p>
                                            </div>
                                            <div class="flex-sm-col col-auto">
                                                <p class="mb-1"><b>0</b><b>đ</b></p>
                                            </div>
                                        </div>
                                        <div class="row justify-content-between">
                                            <div class="col-4">
                                                <p><b>Total</b></p>
                                            </div>
                                            <div class="flex-sm-col col-auto">
                                                <p class="mb-1"><b id="total-2"></b><b>đ</b></p>
                                            </div>
                                        </div>
                                        <hr class="my-0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    const searchParams = new URLSearchParams(window.location.search);
    const vnp_ResponseCode = searchParams.get('vnp_ResponseCode');
    const handleDelete = (id) => {
        console.log(id)
        const user = JSON.parse(localStorage.getItem('authenticatedUser'))
        const cart = user?.cartItems ?? [];
        var newArray = cart.filter(function (item) {
            return item.id !== id;
        });

        user.cartItems = newArray
        localStorage.setItem('authenticatedUser', JSON.stringify(user))
        fetchData()
    }
    let products = [];
    let total = 0;
    async function fetchData() {
        const cart = JSON.parse(localStorage.getItem('authenticatedUser'))?.cartItems ?? [];
        $('#list-product-cart').empty();
        try {
            const response = await fetch('/api/products/by-ids/' + cart.map(p => p.id).join("_"));
            const { data } = await response.json();
            console.log(data);
            const filteredBooks = data
                .map(book => {
                    const newItem = cart.find(item => item.id === book._id);
                    if (newItem) {
                        return { ...book, quantityIncart: newItem.quantity };
                    }
                })
                .filter(item => item !== undefined);
            products = [...filteredBooks];
            filteredBooks.forEach((book) => {
                total += book.quantityIncart * book.price;
                var newDiv = $('<div>', {
                    class: 'row  justify-content-between',
                    html: `
                                        <div class="col-auto col-md-7">
                                            <div class="media flex-column flex-sm-row">
                                                <img class=" img-fluid" src="${book.image}" width="62"
                                                    height="62">
                                                <div class="media-body  my-auto">
                                                    <div class="row ">
                                                        <div class="col-auto">
                                                            <p class="mb-0"><b>${book.name}</b></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class=" pl-0 flex-sm-col col-auto  my-auto">
                                            <p class="boxed-1">${book.quantityIncart}</p>
                                        </div>
                                        <div class=" pl-0 flex-sm-col col-auto  my-auto ">
                                            <p><b>${(book.price * book.quantityIncart).toLocaleString()}0</b><b>đ</b></p>
                                        </div>
                                `
                });
                $('#list-product-cart').append(newDiv)
            })
            $('#total-1').text(total.toLocaleString());
            $('#total-2').text(total.toLocaleString());
        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }
    $(document).ready(function () {
        // Gán sự kiện click cho nút có id là "btn-payment"
        $('#btn-payment').click(function () {
            console.log('Nút "Thanh toán" đã được click.');
            $('#btn-about-product').removeClass('active');
            $('#btn-details').addClass('active');
            $('#about-product').removeClass('show active');
            $('#details').addClass('show active');
        });
        $('#btn-details').click(function () {
            $('#btn-about-product').removeClass('active');
            $('#btn-details').addClass('active');
            $('#about-product').removeClass('show active');
            $('#details').addClass('show active');
        });
        $('#btn-about-product').click(function () {
            $('#btn-details').removeClass('active');
            $('#btn-about-product').addClass('active');
            $('#about-product').addClass('show active');
            $('#details').removeClass('show active');
        });
        $('#btn-confirm').click(function (e) {
            e.preventDefault();
            const paymentMethod = $('input[name="payment-method"]:checked').val() == '#cod' ? 0 : 1;
            fetch('/api/vn-pay/create-payment?amount=' + total).then(res => res.json()).then(res => {
                const { id, data } = res;
                if (paymentMethod)
                    localStorage.setItem('pending',
                        JSON.stringify({ orderId: id, products: products })
                    );
                else
                    localStorage.setItem('success',
                        JSON.stringify(
                            [
                                { orderId: id, products: products },
                                ...(JSON.parse(localStorage.getItem('success')) || [])
                            ]
                        )
                    );
                window.location.href = data;
            });
        });
    });
    function returnPayment() {
        if (vnp_ResponseCode == '00') {
            const query = window.location.href.split('?').filter((u, index) => index !== 0).join()
            fetch('/api/vn-pay/confirm-payment?' + query).then(res => res.json()).then(res => {
                const { data } = res;
                if (localStorage.getItem('pending'))
                    localStorage.setItem('success',
                        JSON.stringify([
                            JSON.parse(localStorage.getItem('pending')),
                            ...(JSON.parse(localStorage.getItem('success')) || [])
                        ]
                        )
                    );
                localStorage.setItem("authenticatedUser", JSON.stringify(
                    { ...JSON.parse(localStorage.getItem('authenticatedUser')), cartItems: [] }
                ));
                localStorage.removeItem("pending");
                alert("Mua hàng thành công");
                fetchData();
            });
        }
        else {
            localStorage.removeItem("pending");
            alert("Mua hàng chưa thành công! Vui lòng thử lại hoặc liên hệ với chúng tôi.")
            fetchData();
        }

    }
    // Gán sự kiện click cho nút hoặc thành phần khác
    if (vnp_ResponseCode != null || vnp_ResponseCode != undefined)
        returnPayment()
    else
        fetchData();

</script>
</html>